## Analysis of murad's dataset
```{r}
.libPaths(c("/liulab/asahu/rserver/R.3.6.3/", "/homes6/mtang/R/x86_64-pc-linux-gnu-library/3.6"))
```

## Enrichment analysis

```{r}
library(tidyr)
crispr = data.table(readxl::read_excel("~/liulab_home/projects/gdt/data/Murad_Screen Hits.xlsx", sheet = 1))

gene.eg.dt = clusterProfiler::bitr(unique(crispr$id), fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")
 kk <- clusterProfiler::enrichKEGG(gene = gene.eg.dt$ENTREZID,
                                    organism     = 'hsa',
                                    pvalueCutoff = 0.05)
  p = clusterProfiler::dotplot(kk, showCategory=30)
 dir.create("results/.figs/murad")
 ggsave(filename = "results/.figs/murad/pathway.pdf",p)
 kk <- clusterProfiler::enrichGO(gene = gene.eg.dt$ENTREZID,
 	 OrgDb    = org.Hs.eg.db,
               ont      = "BP",
                                    pvalueCutoff = 0.05)
  p = clusterProfiler::dotplot(kk, showCategory=30)
 ggsave(filename = "results/.figs/murad/go.pathway.pdf",p)
 
```

## TCGA survival analysis 

```{r}
library(coxme)
library(data.table)
library(magrittr)
library(parallel)
library(survival)
library(survminer)

calculate.cox.interaction = function(dtx){
	tryCatch(
	{
		dtx = dtx[!is.na(gene)]
		aa =  coxph(Surv(Survival, Event) ~ gene + cell.type + gene*cell.type, dtx)
		summary(aa)$coefficients[,c(1,5)] %>% t%>% c
	},
	error=  function(e) rep(NA,6)
	)
}
calculate.cox.interaction.tr = function(dtx){
    tryCatch(
    {
        dtx = dtx[!is.na(gene)]
        aa =  coxph(Surv(Survival, Event) ~ gene + trg +  gene*trg , dtx)%>%
      summary 
    	xx = aa$coefficient
        xx["gene:trg",]
    },
    error=  function(e) rep(NA,5),
    warning = function(e) rep(NA,5)
    )
}
```


```{r}


project.exp = readRDS("~/liulab_home/data/tcga/TCGA_gdc/tcgabiolinks/all.tcga.expression.RDS")
library(SummarizedExperiment)
skcm.inx = which(colData(project.exp)$project_id == "TCGA-SKCM")
project.exp.skcm = project.exp[,skcm.inx] 

project.exp.mat = assay(project.exp.skcm) %>%
set_rownames(rowData(project.exp.skcm)$external_gene_name) 

project.mat.libsize = project.exp.mat %>% 
 colMeans

project.exp.mat %<>% sweep(., project.mat.libsize, MARGIN = 2, FUN = "/")
colnames(project.exp.mat) %<>% substring(.,1,16)
project.skcm = project.exp.mat

dt.skcm = colData(project.exp.skcm) %>% as.data.table %>%
.[,.(days_to_death, days_to_last_follow_up, vital_status, dataset=project_id)] %>% 
.[,Event:=ifelse(vital_status=="Dead", 1, 0)]%>% 
.[,Survival:=ifelse(vital_status=="Dead", days_to_death, days_to_last_follow_up)]

crispr.genes = intersect(rownames(project.exp.mat), crispr$id)
crispr.cox.out = lapply(crispr.genes, function(crispr.gene){ 
      dt.skcm[,trg:=project.skcm[crispr.gene,]]
      xx = rep(NA,5)
      try({
      	out = coxph(Surv(Survival, Event) ~ trg, data=dt.skcm) %>% summary 
      	xx = out$coefficient["trg",]

      })
      xx
    }) %>% do.call(rbind, .) %>%
    data.table %>% 
    set_colnames(c("estimate", "exp", "se", "z", "P")) %>% 
    .[,gene:=crispr.genes]

crispr.cox.out[,padj:=p.adjust(P,method="fdr")]

library(EnhancedVolcano)
p = EnhancedVolcano(crispr.cox.out,
	lab = crispr.cox.out$gene,
	x = 'estimate',
	y = 'P',
	pCutoff = 1E-2,
	FCcutoff = .2,
	# pointSize = c(ifelse(crispr.cox.out$padj <  .1, 3, 2)),
	labSize = 4.0,
	legend=c('NS','Estimate','P value',
		'P value & Estimate'),
	legendPosition = 'bottom',
	legendLabSize = 8,
	legendIconSize = 4.0,
	drawConnectors = TRUE,
	widthConnectors = 0.2,
	xlim = c(-.5, .5),
	colAlpha = 0.8,
	colConnectors = 'grey30'
	)
ggsave(file="results/.figs/murad/cox.pdf",p)

gene.order = crispr.cox.out[order(estimate)]$gene
avi.dt = lapply(gene.order, function(crispr.gene) {
	dt.skcm %>% 
	mutate(expr=project.skcm[crispr.gene,],gene=crispr.gene)
}%>% 
mutate(expr.r=ifelse(expr> median(expr), "high", "low"))
	) %>% do.call(rbind,.)

for (start in seq(1,69,16)) {
	end = start +15
	end = ifelse(end>70, 70, end)
	gene.order.curr = gene.order[seq(start,end)]
	avi.curr = avi.dt[gene %in% gene.order.curr]
	avi.curr$gene %<>% factor(.,levels=gene.order.curr)
	fit1 <- survfit( Surv(Survival, Event) ~ expr.r, data = avi.curr)
	p = ggsurvplot_facet( fit1, avi.curr, facet.by = "gene",  palette = "jco", pval = TRUE)
	ggsave(sprintf("results/.figs/murad/cox.%s.pdf", start), width=10, height=8)
}

## Identify if this genes are enriched for correlation with TRD allele levels. 
temp = c("TRDV2", "TRGV9")
trg.alleles = grep("^TR[GD]V",rownames(project.skcm), value=T) %>% sort
trg.alleles = c(temp, setdiff(trg.alleles , temp))
trg.crispr.cor = WGCNA::corAndPvalue(project.skcm[trg.alleles,] %>% t, project.skcm[gene.order,] %>% t)
library(corrplot)
pdf("results/.figs/murad/cor.trg.pdf", width=16, height=8)
# corrplot(trg.crispr.cor$cor, p.mat = trg.crispr.cor$p, insig = "label_sig",
         # sig.level = c(1E-8, 1E-3, .01), pch.cex = .9, pch.col = "white")
corrplot(trg.crispr.cor$cor, method="square")
dev.off()



crispr.interaction.out.skcm = lapply(trg.alleles, function(trg.allele){ 
    dt.skcm[,trg:=project.skcm[trg.allele,]]%>%
      .[,CD8B:=project.skcm["CD8B",]]
    out = mclapply(gene.order, function(ii) {
        dt.skcm[,gene:=project.skcm[ii,]]%>%
        calculate.cox.interaction.tr
    }, mc.cores = 60) %>% 
    do.call(rbind, .) %>%
    data.table %>% 
    set_colnames(c("estimate", "exp", "se", "z", "P")) %>% 
    .[,gene:=gene.order]
    out 
}) 
names(crispr.interaction.out.skcm) = trg.alleles
crispr.interaction.mat = lapply(crispr.interaction.out.skcm, function(tt) {
	ifelse(tt$P<0.03, tt$z,0)
} )%>% do.call(rbind, .) %>% 
set_colnames(gene.order)

sel = apply(crispr.interaction.mat,1,function(tt) tt %>% is.na %>% sum) < length(gene.order)
crispr.interaction.mat = crispr.interaction.mat[sel,]
pdf("results/.figs/murad/interaction.trg.pdf", width=16, height=8)
corrplot(crispr.interaction.mat, is.corr = FALSE, method = "square")
dev.off()

## plotting an example 

out = dt.skcm 
avi.dt = out %>%
.[,TRGV9:=project.skcm["TRGV9",]] %>% 
.[,TRGV9:=ifelse(TRGV9> median(TRGV9),"high", "low")] %>% 
.[,BTN3A1:=as.numeric(project.skcm["BTN3A1",])] %>% 
.[,BTN3A1:=ifelse(BTN3A1> median(BTN3A1),"high", "low")]

fit1 <- survfit( Surv(Survival, Event) ~ BTN3A1, data = avi.dt)
p = ggsurvplot_facet( fit1, avi.dt, facet.by = "TRGV9",  palette = "jco", pval = TRUE)
ggsave("results/.figs/murad/TRGV9.BTN3A1.km.pdf")

fit1 <- survfit( Surv(Survival, Event) ~TRGV9 , data = avi.dt)
p = ggsurvplot_facet( fit1, avi.dt, facet.by = "BTN3A1",  palette = "jco", pval = TRUE)
ggsave("results/.figs/murad/BTN3A1.TRGV9.km.pdf")
```

1) Is it possible to correlate the BTN2A1/3A1 and the mevalonate genes to survival across all the different cancer types? Or is that too laborious/computationally expensive?
2) Is it possible to correlate the same genes to Vg9/Vd2 alleles across all the different cancer types?
For both of these questions, I am partly thinking of Figure 2 of Kai and Shirley's Science paper.

```{r}
mevalonate.genes =  data.table(readxl::read_excel("~/liulab_home/projects/gdt/data/Murad_Screen Hits.xlsx", sheet = 2))
mevalonate.genes = mevalonate.genes$id[seq(2,20)]
crispr.genes = c(mevalonate.genes, "BTN2A1", "BTN3A1")
all.cox =list()
for (cancer.curr in unique(dt.curr$dataset)) {
	cancer.curr.inx = dt.curr$dataset==cancer.curr
	dt.cancer.curr = dt.curr[cancer.curr.inx,]
	project.cancer.curr = project.exp.mat[,cancer.curr.inx]

	crispr.cox.out = lapply(crispr.genes, function(crispr.gene){ 
		dt.cancer.curr[,trg:=project.cancer.curr[crispr.gene,]]
		xx = rep(NA,5)
		try({
			out = coxph(Surv(Survival, Event) ~ trg, data=dt.cancer.curr) %>% summary 
			xx = out$coefficient["trg",]
		})
		xx
	}) %>% do.call(rbind, .) %>%
	data.table %>% 
	set_colnames(c("estimate", "exp", "se", "z", "P")) %>% 
	.[,gene:=crispr.genes]

	crispr.cox.out[,padj:=p.adjust(P,method="fdr")]
	crispr.cox.out$cancer.type = cancer.curr
	all.cox[[cancer.curr]]= crispr.cox.out
}
all.cox.dt = all.cox %>% do.call(rbind,.) %>% as.data.table
all.cox.dt[,plot.value:=ifelse(padj<0.05, z, 0)]
out = dcast(all.cox.dt, gene~cancer.type, value.var="plot.value" ) 
out.mat = out[,-1,with=F] %>% as.matrix %>% 
set_rownames(out$gene)
out.mat = out.mat[crispr.genes,]
pdf("~/liulab_home/projects/gdt/results/.figs/murad/pancancer.interaction.trg.melavolante.pdf", width=16, height=8)
corrplot(t(out.mat), is.corr = FALSE, method = "square")
dev.off()

trd2.cor = list()
trg9.cor = list()
for(cancer.curr in unique(dt.curr$dataset)) {
	cancer.curr.inx = dt.curr$dataset==cancer.curr
	dt.cancer.curr = dt.curr[cancer.curr.inx,]
	project.cancer.curr = project.exp.mat[,cancer.curr.inx]
	trdv29.alleles = c("TRDV2", "TRGV9")
	trg.crispr.cor = WGCNA::corAndPvalue(project.cancer.curr[trdv29.alleles,] %>% t, project.cancer.curr[crispr.genes,] %>% t)
	trd2.cor[[cancer.curr]] = trg.crispr.cor$cor["TRDV2",]
	trg9.cor[[cancer.curr]] = trg.crispr.cor$cor["TRGV9",]
}

pdf("~/liulab_home/projects/gdt/results/.figs/murad/pancancer.cor.trd2..melavolante.pdf", width=16, height=8)
corrplot(do.call(rbind,trd2.cor), method="square")
dev.off()
pdf("~/liulab_home/projects/gdt/results/.figs/murad/pancancer.cor.trg9..melavolante.pdf", width=16, height=8)
corrplot(do.call(rbind,trg9.cor), method="square")
dev.off()
```

## Murad hits all genes
# 1. GSEA analysis 
# 2. MSIG db enrichment. Check melavolnte pathway. 

```{r}
library(magrittr)
library(tidyr)
library(clusterProfiler)
library(enrichplot)
library(data.table)
library(ggplot2)
library()
crispr = data.table(readxl::read_excel("../../data/Murad_Screen_Data.xlsx", sheet = 1))
gene.eg.dt = clusterProfiler::bitr(unique(crispr$id), fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db") %>% as.data.table
crispr$ENTREZID = gene.eg.dt[match(crispr$id,gene.eg.dt$SYMBOL),]$ENTREZID
crispr = crispr[!is.na(ENTREZID)]

geneList = (crispr$`neg|rank`) %>% 
set_names(crispr$ENTREZID) %>%  
sort(., decreasing = TRUE)
geneList = geneList[!(names(geneList) %>% duplicated)]
geneList.rev = (crispr$`pos|rank`) %>% 
set_names(crispr$ENTREZID) %>%  
sort(., decreasing = TRUE)
geneList.rev = geneList.rev[!(names(geneList.rev) %>% duplicated)]


ego3 <- gseKEGG(geneList     = geneList,
               organism     = 'hsa',
               minGSSize =2,
               pvalueCutoff = 1,
               verbose      = FALSE)

ego5 <- gseGO(geneList     = geneList,
              OrgDb        = org.Hs.eg.db,
              ont          = "BP",
              nPerm        = 1000,
              minGSSize    = 4,
              maxGSSize    = 500,
              pvalueCutoff = 1,
              verbose      = FALSE)

ego6 <- gseGO(geneList     = geneList,
              OrgDb        = org.Hs.eg.db,
              ont          = "MF",
              nPerm        = 1000,
              minGSSize    = 4,
              maxGSSize    = 500,
              pvalueCutoff = 1,
              verbose      = FALSE)

## Wikipathways
wp2gene <- read.gmt("~/liulab_home/data/pathways/wikipathways/wikipathways-20200710-gmt-Homo_sapiens.gmt")
wp2gene <- wp2gene %>% tidyr::separate(ont, c("name","version","wpid","org"), "%")
wpid2gene <- wp2gene %>% dplyr::select(wpid, gene) #TERM2GENE
wpid2name <- wp2gene %>% dplyr::select(wpid, name) #TERM2NAME

ewp <- GSEA(geneList.rev, minGSSize =2, TERM2GENE = wpid2gene, TERM2NAME = wpid2name)
ehead(ewp)

ewp.up <- GSEA(geneList, minGSSize =2, TERM2GENE = wpid2gene, TERM2NAME = wpid2name, pvalueCutoff = 1)
head(ewp.up)

p = gseaplot2(ewp, geneSetID = 1:5)

  p = clusterProfiler::dotplot(ewp.up, showCategory=50)
p = clusterProfiler::dotplot(ewp, showCategory=50)
    
 dir.create("results/.figs/murad")
 ggsave(filename = "results/.figs/murad/pathway.pdf",p)
 kk <- clusterProfiler::enrichGO(gene = gene.eg.dt$ENTREZID,
 	 OrgDb    = org.Hs.eg.db,
               ont      = "BP",
                                    pvalueCutoff = 0.05)
  p = clusterProfiler::dotplot(kk, showCategory=30)
 ggsave(filename = "results/.figs/murad/go.pathway.pdf",p)
 
```

## 
It would be super helpful if you could do your analysis looking at survival differences across all cancer types and the one ICB cohort with enough patients where you look at interactions between each of these genes and TRD/G genes. 
```{r}

crispr.genes =  data.table(readxl::read_excel("~/liulab_home/projects/gdt/data/2020-0817.Murad_Top_Hits.xlsx", sheet = 1))
gene.order = crispr.genes$id
gene.order = ifelse(gene.order=="GLTSCR1", "BICRA", gene.order)

project.exp.mat = assay(project.exp) %>%
set_rownames(rowData(project.exp)$external_gene_name) 

project.mat.libsize = project.exp.mat %>% 
 colMeans

project.exp.mat %<>% sweep(., project.mat.libsize, MARGIN = 2, FUN = "/")
colnames(project.exp.mat) %<>% substring(.,1,16)

temp = c("TRDV2", "TRGV9")
trg.alleles = grep("^TR[GD][VC]",rownames(project.exp.mat), value=T) %>% sort

dt.curr = colData(project.exp) %>% as.data.table %>%
.[,.(days_to_death, days_to_last_follow_up, vital_status, dataset=project_id)] %>% 
.[,Event:=ifelse(vital_status=="Dead", 1, 0)]%>% 
.[,Survival:=ifelse(vital_status=="Dead", days_to_death, days_to_last_follow_up)]

all.genes = c(trg.alleles, gene.order) %>% unique
crispr.interaction.out.cancertypes = crispr.interaction.mats = list()
cancer.types = unique(dt.curr$dataset)
for (cancer.type in cancer.types) {
  print(sprintf("processing %s ... ", cancer.type))
  cancertype.inx = which(dt.curr$dataset==cancer.type)
  project.cancertype = project.exp.mat[all.genes,cancertype.inx] %>% t %>% 
  scale(., scale=T, center=F) %>% t
  dt.cancertype = dt.curr[dataset==cancer.type]
  
  crispr.interaction.out.cancertype = lapply(trg.alleles, function(trg.allele){ 
    dt.cancertype[,trg:=project.cancertype[trg.allele,]]
    out = mclapply(gene.order, function(ii) {
      dt.cancertype[,gene:=project.cancertype[ii,]]%>%
        calculate.cox.interaction.tr
    }, mc.cores = 16) %>% 
      do.call(rbind, .) %>%
      data.table %>% 
      set_colnames(c("estimate", "exp", "se", "z", "P")) %>% 
      .[,gene:=gene.order]
    out 
  }) 
  names(crispr.interaction.out.cancertype) = trg.alleles
  
  crispr.interaction.mat = lapply(crispr.interaction.out.cancertype, function(tt) {
    ifelse(tt$P<0.03, tt$z, 0)
  } )%>% do.call(rbind, .) %>% 
    set_colnames(gene.order)
  crispr.interaction.mats[[cancer.type]] = crispr.interaction.mat
  crispr.interaction.out.cancertypes[[cancer.type]] = crispr.interaction.out.cancertype
}

crispr.interaction.mats2 = lapply(names(crispr.interaction.mats), function(tt){
  tt1 = gsub("TCGA-", tt, replacement = "")
  crispr.interaction.mats[[tt]] %>% 
    set_rownames(paste(tt1, rownames(crispr.interaction.mats[[tt]])))
} ) %>% do.call(rbind,.)


sel = rowMeans(is.na(crispr.interaction.mats2) | (crispr.interaction.mats2==0)) < 1
crispr.interaction.mats2 = crispr.interaction.mats2[sel,]
pdf("/liulab/asahu/projects/gdt/results/.figs/murad/2020-0817.interaction.trg.pdf", width=17, height=8)
corrplot::corrplot(t(crispr.interaction.mats2), is.corr = FALSE, method = "square", tl.cex = 0.45)
dev.off()

crispr.interaction.out.cancertypes2 = lapply(names(crispr.interaction.out.cancertypes), function(tt) {
  zz = crispr.interaction.out.cancertypes[[tt]]
  lapply(names(zz), function(uu) {
    aa = crispr.interaction.out.cancertypes[[tt]][[uu]]
    aa[,cancertype:=gsub("TCGA-", tt, replacement = "")][,trdg:=uu]
  }) %>% do.call(rbind,.) 
}) %>% do.call(rbind,.) 
crispr.interaction.out.cancertypes2[,lab:=paste(gene,trdg, cancertype, sep=",")]
crispr.interaction.out.cancertypes2[,estimate2:=ifelse(P<0.05, estimate, ifelse(abs(estimate) < 1, estimate, 0))]
crispr.interaction.out.cancertypes2[,estimate2:=ifelse(abs(estimate2)<2.5, estimate2, sign(estimate2)*2.5)]

  
library(EnhancedVolcano)
p = EnhancedVolcano(crispr.interaction.out.cancertypes2,
	lab = crispr.interaction.out.cancertypes2$lab,
	x = 'estimate2',
	y = 'P',
	pCutoff = 2E-3,
	FCcutoff = 0.1,
	# pointSize = c(ifelse(crispr.cox.out$padj <  .1, 3, 2)),
	labSize = 2.0,
	legend=c('NS','Estimate','P value',
		'P value & Estimate'),
	legendPosition = 'bottom',
	legendLabSize = 8,
	legendIconSize = 4.0,
	drawConnectors = TRUE,
	widthConnectors = 0.2,
	# xlim = c(-.5, .5),
	ylim = c(0, 5),
	colAlpha = 0.8,
	colConnectors = 'grey30'
	)
ggsave("/liulab/asahu/projects/gdt/results/.figs/murad/2020-0817.interaction.volcano.pdf", width=16, height=8)

crispr.interaction.out.cancertypes2 = crispr.interaction.out.cancertypes2[order(P)]
write.table(x = crispr.interaction.out.cancertypes2, file="/liulab/asahu/projects/gdt/results/.figs/murad/2020-0817.interaction.txt", sep="\t", row.names = F, col.names = T, quote = F)

```

